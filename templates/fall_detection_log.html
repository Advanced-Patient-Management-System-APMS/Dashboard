<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚™ìƒ ê°ì§€ ì´ë ¥</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f7f6; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); padding: 24px; }
        h1 { color: #d9534f; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-top: 0; }
        .filter-section { display: flex; gap: 15px; align-items: center; margin-bottom: 25px; padding: 20px; background-color: #f9f9f9; border-radius: 8px; }
        .filter-section label { font-weight: 500; }
        .filter-section input[type="date"] { font-family: inherit; font-size: 15px; padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; }
        #search-button { padding: 10px 20px; font-size: 16px; font-weight: 600; color: #fff; background-color: #007bff; border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; }
        #search-button:hover { background-color: #0056b3; }
        .results-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .results-table th, .results-table td { padding: 12px 15px; border-bottom: 1px solid #ddd; text-align: left; }
        .results-table th { background-color: #f8f9fa; font-weight: 600; color: #495057; }
        .results-table tbody tr:hover { background-color: #f1f3f5; }
        .confirm-button { padding: 6px 12px; font-size: 14px; color: #fff; background-color: #dc3545; border: none; border-radius: 5px; cursor: pointer; }
        .confirmed { background-color: #28a745; cursor: default; }
        #no-results { text-align: center; padding: 30px; color: #868e96; font-size: 18px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸš¨ ë‚™ìƒ ê°ì§€ ì´ë ¥</h1>
        <div class="filter-section">
            <label for="start-date">ì‹œì‘ì¼:</label>
            <input type="date" id="start-date">
            <label for="end-date">ì¢…ë£Œì¼:</label>
            <input type="date" id="end-date">
            <button id="search-button">ì¡°íšŒí•˜ê¸°</button>
        </div>

        <table class="results-table">
            <thead>
                <tr>
                    <th>ë°œìƒ ì‹œê°„ (ìµœì‹ ìˆœ)</th>
                    <th>í˜¸ì‹¤</th>
                    <th>í™˜ìëª…</th>
                    <th>í™•ì¸ ìƒíƒœ</th>
                </tr>
            </thead>
            <tbody id="log-table-body">
                </tbody>
        </table>
        <div id="no-results" style="display: none;">
            í•´ë‹¹ ê¸°ê°„ì— ê°ì§€ëœ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.
        </div>
    </div>

    <script>
        // --- ê°€ìƒ ë°ì´í„° (allFallEvents) ì‚­ì œ ---
        // ì´ì œ ì´ ë°ì´í„°ëŠ” app.py ì„œë²„ì— ìˆìŠµë‹ˆë‹¤.

        // DOM ìš”ì†Œ ì„ íƒ
        const startDateInput = document.getElementById("start-date");
        const endDateInput = document.getElementById("end-date");
        const searchButton = document.getElementById("search-button");
        const tableBody = document.getElementById("log-table-body");
        const noResultsMessage = document.getElementById("no-results");

        // 'ì¡°íšŒí•˜ê¸°' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        searchButton.addEventListener("click", function() {
            // ì´ í•¨ìˆ˜ê°€ ì´ì œ ì„œë²„ì— ë°ì´í„°ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤.
            fetchDataAndRenderTable();
        });

        // ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ í…Œì´ë¸”ì„ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
        function fetchDataAndRenderTable() {
            const startDateValue = startDateInput.value;
            const endDateValue = endDateInput.value;

            if (!startDateValue || !endDateValue) {
                alert("ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            // 1. ì„œë²„ API í˜¸ì¶œ (app.pyì˜ /api/fall_events)
            // fetchë¥¼ ì‚¬ìš©í•´ ì„œë²„ì— GET ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.
            fetch(`/api/fall_events?start=${startDateValue}&end=${endDateValue}`)
                .then(response => {
                    // ì‘ë‹µì´ ì„±ê³µì ì´ì§€ ì•Šìœ¼ë©´ ì—ëŸ¬ ì²˜ë¦¬
                    if (!response.ok) {
                        throw new Error('ì„œë²„ ì‘ë‹µì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.');
                    }
                    // ì‘ë‹µì„ JSON í˜•íƒœë¡œ íŒŒì‹±
                    return response.json();
                })
                .then(data => {
                    // 2. ë°›ì•„ì˜¨ ë°ì´í„°(data)ë¡œ í…Œì´ë¸” ì—…ë°ì´íŠ¸
                    updateTable(data);
                })
                .catch(error => {
                    // 3. ì—ëŸ¬ ì²˜ë¦¬
                    console.error('ë°ì´í„° ë¡œë”© ì¤‘ ì—ëŸ¬ ë°œìƒ:', error);
                    alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                });
        }

        // í…Œì´ë¸”ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜ (ì´ì „ê³¼ ë™ì¼)
        function updateTable(data) {
            tableBody.innerHTML = ""; 
            noResultsMessage.style.display = "none";

            if (data.length === 0) {
                noResultsMessage.style.display = "block";
                return;
            }

            // ìµœì‹ ìˆœ ì •ë ¬ (ì„œë²„ì—ì„œ ì•ˆí–ˆë‹¤ë©´ ì—¬ê¸°ì„œ ìˆ˜í–‰)
            data.sort((a, b) => new Date(b.time) - new Date(a.time));

            data.forEach(event => {
                const row = document.createElement("tr");
                const statusButton = (event.status === 'pending')
                    ? `<button class="confirm-button">í™•ì¸í•˜ê¸°</button>`
                    : `<button class="confirm-button confirmed" disabled>ì¡°ì¹˜ ì™„ë£Œ</button>`;

                row.innerHTML = `
                    <td>${event.time}</td>
                    <td>${event.room}</td>
                    <td>${event.patient}</td>
                    <td>${statusButton}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // 'í™•ì¸í•˜ê¸°' ë²„íŠ¼ í´ë¦­ ì‹œ ìƒíƒœ ë³€ê²½ (ì´ì „ê³¼ ë™ì¼)
        tableBody.addEventListener('click', function(e) {
            if (e.target.classList.contains('confirm-button') && !e.target.classList.contains('confirmed')) {
                // (ì°¸ê³ : ì‹¤ì œ ì•±ì—ì„œëŠ” ì´ í´ë¦­ì„ ì„œë²„ë¡œ ë³´ë‚´ DB ìƒíƒœë¥¼ 'confirmed'ë¡œ ì—…ë°ì´íŠ¸í•´ì•¼ í•¨)
                e.target.textContent = 'ì¡°ì¹˜ ì™„ë£Œ';
                e.target.classList.add('confirmed');
                e.target.disabled = true;
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            const twoWeeksAgo = new Date();
            twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);
            const twoWeeksAgoString = twoWeeksAgo.toISOString().split('T')[0];

            startDateInput.value = twoWeeksAgoString;
            endDateInput.value = today;
            
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ì¡°íšŒ ì‹¤í–‰
            fetchDataAndRenderTable(); 
        }

        document.addEventListener('DOMContentLoaded', setDefaultDates);
    </script>
</body>
</html>