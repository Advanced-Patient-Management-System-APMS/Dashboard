<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>병원 대시보드</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #212529;
            font-family: 'Noto Sans KR', sans-serif;
            color: #f8f9fa;
            overflow-x: hidden; 
        }

        /* --- 슬라이드 메뉴 --- */
        #slide-menu {
            position: fixed; top: 0; left: 0;
            width: 200px; height: 100vh;
            background: #343a40;
            z-index: 1200;
            box-shadow: 2px 0 24px rgba(0,0,0,0.17);
            transform: translateX(-100%);
            transition: transform 0.4s cubic-bezier(0.25,0.8,0.25,1);
        }
        #slide-menu.open { transform: translateX(0); }
        #bookmark-tabs .floor-btn { display: block; width: 100%; padding: 15px 25px; text-align: center; font-size: 1.1em; font-weight: 500; border: none; border-bottom: 1px solid #495057; background-color: transparent; color: #adb5bd; transition: all 0.2s ease-in-out; cursor: pointer; }
        #bookmark-tabs .floor-btn.active, #bookmark-tabs .floor-btn:hover { background-color: #0d6efd; color: white; }
        
        /* --- 메뉴 토글 버튼 --- */
        #menu-toggle-btn {
            position: fixed;
            left: 20px;
            top: 50%; 
            transform: translateY(-50%);
            z-index: 1300; 
            background:#0d6efd; 
            color:#fff; 
            border:none;
            border-radius: 0 1em 1em 0; 
            padding:16px 12px; 
            font-size:1.5em; 
            cursor:pointer;
            transition: left 0.4s cubic-bezier(0.25,0.8,0.25,1);
        }
        /* 메뉴가 열렸을 때 버튼 위치 이동 */
        #slide-menu.open + #menu-toggle-btn {
            left: 200px;
        }

        /* ▼▼▼ [핵심 수정] 메인 콘텐츠 영역 스타일 ▼▼▼ */
        #main-content-box {
            padding: 30px;
            transition: margin-left 0.4s cubic-bezier(0.25,0.8,0.25,1);
        }
        /* 메뉴가 열렸을 때 메인 콘텐츠를 오른쪽으로 밀어냄 */
        #slide-menu.open ~ #main-content-box {
            margin-left: 200px;
        }

        /* --- 상단 고정 요소 (main-content-box 내부로 이동) --- */
        #realtime-clock { position: absolute; top: 30px; right: 30px; font-size: 1.6em; font-weight: 600; color: #e9ecef; }
        #user-welcome { position: absolute; top: 80px; right: 30px; color: #adb5bd; font-size: 1.3em; text-align: right; font-weight: 500; }
        .logout-link { color: #ced4da; text-decoration: underline; font-size: 0.9em; margin-left: 8px; }
        .logout-link:hover { color: white; }

        .main-title { font-size: 2.2em; font-weight: 700; color: #f8f9fa; margin-bottom: 20px; text-align: center; }
        #current-floor-title { padding-bottom: 15px; margin-bottom: 20px; border-bottom: 1px solid #495057; font-size: 1.8em; font-weight: 700; color: #f8f9fa; }
    </style>
</head>
<body>

<!-- ▼▼▼ [구조 수정] 슬라이드 메뉴와 토글 버튼 ▼▼▼ -->
<div id="slide-menu">
    <div id="bookmark-tabs">
        <h4 style="padding: 15px 25px;">층별 현황</h4>
        <div class="floor-btn active" data-floor="1">1층</div>
        <div class="floor-btn" data-floor="2">2층</div>
        <div class="floor-btn" data-floor="3">3층</div>
        <hr style="margin: 20px 25px; border-color: #495057;">
        <a href="{{ url_for('register_patient') }}" class="floor-btn" style="text-decoration: none;">
            <i class="fas fa-user-plus"></i> &nbsp; 환자 등록
        </a>
    </div>
</div>
<button id="menu-toggle-btn"><i class="fas fa-bars"></i></button>

<!-- ▼▼▼ [구조 수정] 불필요한 div 제거 및 id 변경, 시계/환영문구 이동 ▼▼▼ -->
<div id="main-content-box">
    <div id="realtime-clock"></div>
    {% if full_name %}
    <div id="user-welcome">
        {{ full_name }}님, 환영합니다.
        <a href="{{ url_for('logout') }}" class="logout-link">(로그아웃)</a>
    </div>
    {% endif %}

    <h1 class="main-title">병실 환자 현황</h1>
    <div id="floor-view">
        <div id="current-floor-title"></div>
        <div id="rooms-area"></div>
    </div>
    <div id="beds-area" style="display: none;"></div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ▼▼▼ [최종] 중복을 모두 제거한 완전한 JavaScript 코드 ▼▼▼
$(function() {
    
    // --- 상태 변수 ---
    let currentFloor = 1;
    let isZoomedIn = false;

    // --- 함수 정의 ---
    function updateClock() {
        const now = new Date();
        const timeString = now.toLocaleString('ko-KR'); // 더 간단한 시간 형식
        $('#realtime-clock').text(timeString);
    }

    function updateContent(floor) {
        currentFloor = floor; // 현재 층 번호 업데이트
        $('#current-floor-title').text(floor + '층 병동');
        $.get('/api/floor_rooms/' + floor, function(html) {
            $('#rooms-area').html(html);
        });
    }

    // --- 초기 실행 ---
    setInterval(updateClock, 1000);
    updateClock();
    updateContent(currentFloor);

    // [핵심] 자동 새로고침 로직
    setInterval(function() {
        if (!isZoomedIn) { // 확대된 상태가 아닐 때만 실행
            updateContent(currentFloor);
        }
    }, 5000);

    // --- 이벤트 핸들러 (중복 제거) ---

    // 1. 층 탭 클릭 이벤트
    $('#bookmark-tabs').on('click', '.floor-btn', function() {
        isZoomedIn = false; // 층을 바꾸면 확대 상태 해제
        $('#bookmark-tabs .floor-btn').removeClass('active');
        $(this).addClass('active');
        var floor = $(this).data('floor');
        if (floor) { // '환자 등록' 버튼은 data-floor가 없으므로 제외
            updateContent(floor);
        }
    });

    // 2. 방 클릭 이벤트 (최종 수정)
$(document).on('click', '.room-box', function(e) {
    e.stopPropagation();
    isZoomedIn = true; // 확대 상태로 변경
    
    var roomBox = $(this);
    var roomName = roomBox.data('room');
    var container = roomBox.closest('.rooms-container');

    if (roomBox.hasClass('selected')) return;

    container.find('.room-box.selected').removeClass('selected').find('.patient-list-container').remove();
    roomBox.addClass('selected');
    container.addClass('zoomed-in');
    
    $.get('/api/patients_in_room/' + roomName, function(beds) {
        roomBox.append('<div class="patient-list-container"></div>');
        var patientListContainer = roomBox.find('.patient-list-container');

        var leftColumnHtml = '';
        var rightColumnHtml = '';

        if (beds && beds.length > 0) {
            // forEach 루프 안에서, data-patients에 저장된 환자 정보도 함께 사용합니다.
            var patientsFromData = roomBox.data('patients');

            beds.forEach(function(bed) {
                var cardHtml = '';
                // 환자가 있는 침대
                if (bed.patient_name) {

                    // ▼▼▼ [핵심] JavaScript 안에서 직접 아이콘 로직을 구현합니다. ▼▼▼
                    let iconHtml = '';
                    // data-patients에서 현재 환자(bed)와 이름이 같은 환자를 찾습니다.
                    var patientData = patientsFromData.find(p => p.patient_name === bed.patient_name);

                    if (patientData && patientData.latest_event_type === 'present') {
                        iconHtml = `<img src="/static/icons/present_icon.png" alt="Present" class="patient-icon">`;
                    } 
                    else if (patientData && patientData.latest_event_type === 'absent') {
                        iconHtml = `<img src="/static/icons/absent_icon.png" alt="Absent" class="patient-icon">`;
                    } 
                    else if (patientData && patientData.latest_event_type === 'meal') {
                        iconHtml = `<img src="/static/icons/meal_icon.png" alt="Meal" class="patient-icon">`;
                    } 
                    else if (patientData && patientData.latest_event_type === 'emergency') {
                        iconHtml = `<img src="/static/icons/emergency_icon.png" alt="Emergency" class="patient-icon">`;
                    }
                    else if (patientData && patientData.latest_event_type === 'sleeping') {
                        iconHtml = `<img src="/static/icons/sleeping_icon.png" alt="Sleeping" class="patient-icon">`;
                    }
                    else if (patientData && patientData.latest_event_type === 'examination') {
                        iconHtml = `<img src="/static/icons/examination_icon.png" alt="Examination" class="patient-icon">`;
                    }  

                    cardHtml = `
                        <div class="patient-detail-card">
                            ${iconHtml} 
                            <div class="patient-info-block">
                                <div class="name">${bed.patient_name}</div>
                                <div class="details">${bed.age}세 / ${bed.gender} / 병명: ${bed.disease || '정보 없음'}</div>
                            </div>
                            <div class="bed-number-box">${bed.bed_number}</div>
                        </div>`;
                } 
                // 빈 침대 (수정 없음)
                else {
                    cardHtml = `
                        <div class="empty-bed-card">
                            <span>비어 있음</span>
                            <div class="bed-number-box">${bed.bed_number}</div>
                        </div>`;
                }

                if (bed.bed_number <= 4) {
                    leftColumnHtml += cardHtml;
                } else {
                    rightColumnHtml += cardHtml;
                }
            });
        }

        // 최종 HTML 조합은 그대로 유지
        var finalHtml = `
            <div class="patient-detail-card" style="background-color: #ced4da; justify-content: center;"><h4 style="color: #212529;">${roomName}</h4></div>
            <div class="bed-grid-container">
                <div class="bed-grid-column">${leftColumnHtml}</div>
                <div class="bed-grid-column">${rightColumnHtml}</div>
            </div>
        `;
        
        patientListContainer.html(finalHtml).fadeIn();
    });
});
    // 3. 배경 클릭 시 축소 이벤트
    $(document).on('click', function(e) {
        var container = $('.rooms-container.zoomed-in');
        if (container.length > 0 && $(e.target).closest('.room-box.selected').length === 0) {
            isZoomedIn = false; // [추가] 배경을 클릭하면 확대 상태 해제
            container.removeClass('zoomed-in');
            // 축소 시, 동적으로 생성했던 상세 보기 컨테이너를 삭제
            container.find('.room-box.selected').removeClass('selected').find('.patient-list-container').remove();
        }
    });
    
    // 4. 슬라이드 메뉴 토글 이벤트
    $('#menu-toggle-btn').on('click', function(e) {
        e.stopPropagation();
        $('#slide-menu').toggleClass('open');
    });

    // 5. 메뉴 바깥쪽 클릭 시 메뉴 닫기 이벤트
    $(document).on('click', function(e) {
        if ($('#slide-menu').hasClass('open') && !$(e.target).closest('#slide-menu').length && !$(e.target).is('#menu-toggle-btn')) {
            $('#slide-menu').removeClass('open');
        }
    });
});
</script>

</body>
</html>