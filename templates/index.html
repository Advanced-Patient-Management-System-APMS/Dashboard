<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>병원 대시보드</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #212529;
            font-family: 'Noto Sans KR', sans-serif;
            color: #f8f9fa; /* 기본 글자색을 밝게 */
        }

        #realtime-clock {
            position: fixed;
            top: 25px;
            right: 30px;
            font-size: 1.1em;
            font-weight: 500;
            color: #e9ecef; /* 밝은 글자색 */
            background-color: rgba(73, 80, 87, 0.8); /* 반투명 어두운 배경 */
            padding: 8px 15px;
            border-radius: 8px;
            z-index: 1000;
        }

        .tab-layout-container {
            display: flex;
            width: 100vw;
            height: 100vh;
            margin: 0;
            max-width: none;
        }

        #bookmark-tabs {
            padding-top: 60px;
            background-color: #343a40;
            z-index: 2;
            flex-shrink: 0;
        }
        #bookmark-tabs .floor-btn {
            display: block;
            min-width: 150px;
            padding: 15px 25px;
            text-align: center;
            font-size: 1.1em;
            font-weight: 500;
            border: none;
            border-bottom: 1px solid #495057;
            background-color: transparent;
            color: #adb5bd;
            border-radius: 0;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        #bookmark-tabs .floor-btn.active,
        #bookmark-tabs .floor-btn:hover {
            background-color: #0d6efd;
            color: white;
        }
        
        #main-content-box {
            flex-grow: 1;
            background-color: #212529;
            padding: 30px;
            overflow-y: auto;
            z-index: 1;
        }

        .main-title {
            font-size: 2.2em;
            font-weight: 700;
            color: #f8f9fa; /* 밝은 글자색 */
            margin-bottom: 20px;
            text-align: center;
        }
        
        #current-floor-title {
            padding-bottom: 15px;
            margin-bottom: 20px;
            border-bottom: 1px solid #495057;
            font-size: 1.8em;
            font-weight: 700;
            color: #f8f9fa;
        }
    </style>
</head>
<body>

<!-- ▼▼▼ [수정] 로고 img 태그 삭제, 시계 div 추가 ▼▼▼ -->
<div id="realtime-clock"></div>

<div class="tab-layout-container">
    <div id="bookmark-tabs">
        <div class="floor-btn active" data-floor="1">1층</div>
        <div class="floor-btn" data-floor="2">2층</div>
        <div class="floor-btn" data-floor="3">3층</div>
    </div>
    <div id="main-content-box">
        <!-- ▼▼▼ [수정] 메인 제목 추가 ▼▼▼ -->
        <h1 class="main-title">병실 환자 현황</h1>

        <div id="floor-view">
            <div id="current-floor-title"></div>
            <div id="rooms-area"></div>
        </div>
        <div id="beds-area" style="display: none;"></div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ▼▼▼ [최종] 중복을 제거한 완전한 JavaScript 코드 ▼▼▼
$(function() {
    // 실시간 시계 기능
    function updateClock() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        const timeString = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        $('#realtime-clock').text(timeString);
    }
    setInterval(updateClock, 1000);
    updateClock();

    // 층 정보 업데이트 함수
    function updateContent(floor) {
        $('#current-floor-title').text(floor + '층 병동');
        $.get('/api/floor_rooms/' + floor, function(html) {
            $('#rooms-area').html(html);
        });
    }

    // --- 이벤트 핸들러 ---

    // 1. 페이지 첫 로드 시 1층 정보 불러오기
    updateContent(1);

    // 2. 책갈피 탭 클릭 이벤트 (중복 제거 후 하나만 남김)
    $('#bookmark-tabs').on('click', '.floor-btn', function() {
        $('#bookmark-tabs .floor-btn').removeClass('active');
        $(this).addClass('active');
        var floor = $(this).data('floor');
        updateContent(floor);

        // 다른 층으로 이동 시, 확대된 방과 환자 목록 초기화
        // JavaScript가 찾는 부모 컨테이너 클래스 이름 확인 (.floor-plan-grid 또는 .rooms-container)
        $('#rooms-area').find('.zoomed-in').removeClass('zoomed-in');
        $('#rooms-area').find('.selected').removeClass('selected');
        $('#patient-list-area').slideUp();
    });

    // ▼▼▼ [수정] 방 클릭 이벤트를 아래 로직으로 완전히 교체 ▼▼▼
    $(document).on('click', '.room-box', function() {
        var roomBox = $(this);
        var roomName = roomBox.data('room');
        var container = roomBox.closest('.rooms-container');

        // 1. 이미 선택된 방을 다시 클릭하면, 선택 해제
        if (roomBox.hasClass('selected')) {
            roomBox.removeClass('selected');
            container.removeClass('zoomed-in');
            // 박스 안에 있는 환자 목록을 찾아서 숨김
            roomBox.find('.patient-list-container').slideUp();
            return;
        }

        // 2. 다른 방이 선택되어 있었다면 먼저 초기화
        container.find('.room-box.selected').removeClass('selected');
        container.removeClass('zoomed-in');
        $('.patient-list-container').slideUp();

        // 3. 현재 클릭한 방에 효과 적용
        roomBox.addClass('selected');
        container.addClass('zoomed-in');

        // 4. 환자 목록을 담을 컨테이너가 없으면, 박스 안에 새로 생성
        if (roomBox.find('.patient-list-container').length === 0) {
            roomBox.append('<div class="patient-list-container"></div>');
        }
        var patientListContainer = roomBox.find('.patient-list-container');
        
        // 5. 환자 목록 API 호출 및 표시
        $.get('/api/patients_in_room/' + roomName, function(patients) {
            var patientListHtml = `<h4 class="mb-3">환자 현황</h4>`;
            if (patients && patients.length > 0) {
                patientListHtml += '<ul class="list-group list-group-flush">';
                patients.forEach(function(p) {
                    patientListHtml += `
                        <li class="list-group-item">
                            <span class="fw-bold me-3">${p['patient name']}</span>
                            <small class="text-muted">(${p.gender}, ${p.age}세, ${p['bed number']}번 침대)</small>
                        </li>`;
                });
                patientListHtml += '</ul>';
            } else {
                patientListHtml += '<p class="text-muted">현재 입원한 환자가 없습니다.</p>';
            }

            // 박스 안의 환자 목록 컨테이너에 내용을 채우고 보여줌
            patientListContainer.html(patientListHtml).slideDown();
        });
    });

    // beds-area 와 back-to-rooms 관련 이벤트는 확대/축소 기능으로 대체되었으므로 삭제합니다.
});
</script>

</body>
</html>