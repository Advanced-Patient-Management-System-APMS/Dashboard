<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>병원 대시보드</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #212529;
            font-family: 'Noto Sans KR', sans-serif;
            color: #f8f9fa;
            overflow-x: hidden; 
        }

        /* --- 슬라이드 메뉴 --- */
        #slide-menu {
            position: fixed; top: 0; left: 0;
            width: 200px; height: 100vh;
            background: #343a40;
            z-index: 1200;
            box-shadow: 2px 0 24px rgba(0,0,0,0.17);
            transform: translateX(-100%);
            transition: transform 0.4s cubic-bezier(0.25,0.8,0.25,1);
        }
        #slide-menu.open { transform: translateX(0); }
        #bookmark-tabs .floor-btn { display: block; width: 100%; padding: 15px 25px; text-align: center; font-size: 1.1em; font-weight: 500; border: none; border-bottom: 1px solid #495057; background-color: transparent; color: #adb5bd; transition: all 0.2s ease-in-out; cursor: pointer; }
        #bookmark-tabs .floor-btn.active, #bookmark-tabs .floor-btn:hover { background-color: #0d6efd; color: white; }
        
        /* --- 메뉴 토글 버튼 --- */
        #menu-toggle-btn {
            position: fixed;
            left: 20px;
            top: 50%; 
            transform: translateY(-50%);
            z-index: 1300; 
            background:#0d6efd; 
            color:#fff; 
            border:none;
            border-radius: 0 1em 1em 0; 
            padding:16px 12px; 
            font-size:1.5em; 
            cursor:pointer;
            transition: left 0.4s cubic-bezier(0.25,0.8,0.25,1);
        }
        /* 메뉴가 열렸을 때 버튼 위치 이동 */
        #slide-menu.open + #menu-toggle-btn {
            left: 200px;
        }

        /* ▼▼▼ [핵심 수정] 메인 콘텐츠 영역 스타일 ▼▼▼ */
        #main-content-box {
            padding: 30px;
            transition: margin-left 0.4s cubic-bezier(0.25,0.8,0.25,1);
        }
        /* 메뉴가 열렸을 때 메인 콘텐츠를 오른쪽으로 밀어냄 */
        #slide-menu.open ~ #main-content-box {
            margin-left: 200px;
        }

        /* --- 상단 고정 요소 (main-content-box 내부로 이동) --- */
        #realtime-clock { position: absolute; top: 30px; right: 30px; font-size: 1.6em; font-weight: 600; color: #e9ecef; }
        #user-welcome { position: absolute; top: 80px; right: 30px; color: #adb5bd; font-size: 1.3em; text-align: right; font-weight: 500; }
        .logout-link { color: #ced4da; text-decoration: underline; font-size: 0.9em; margin-left: 8px; }
        .logout-link:hover { color: white; }

        .main-title { font-size: 2.2em; font-weight: 700; color: #f8f9fa; margin-bottom: 20px; text-align: center; }
        #current-floor-title { padding-bottom: 15px; margin-bottom: 20px; border-bottom: 1px solid #495057; font-size: 1.8em; font-weight: 700; color: #f8f9fa; }
    </style>
</head>
<body>

<!-- ▼▼▼ [구조 수정] 슬라이드 메뉴와 토글 버튼 ▼▼▼ -->
<div id="slide-menu">
    <div id="bookmark-tabs">
        <h4 style="padding: 15px 25px;">층별 현황</h4>
        <div class="floor-btn active" data-floor="1">1층</div>
        <div class="floor-btn" data-floor="2">2층</div>
        <div class="floor-btn" data-floor="3">3층</div>
        <hr style="margin: 20px 25px; border-color: #495057;">
        <a href="{{ url_for('register_patient') }}" class="floor-btn" style="text-decoration: none;">
            <i class="fas fa-user-plus"></i> &nbsp; 환자 등록
        </a>
    </div>
</div>
<button id="menu-toggle-btn"><i class="fas fa-bars"></i></button>

<!-- ▼▼▼ [구조 수정] 불필요한 div 제거 및 id 변경, 시계/환영문구 이동 ▼▼▼ -->
<div id="main-content-box">
    <div id="realtime-clock"></div>
    {% if full_name %}
    <div id="user-welcome">
        {{ full_name }}님, 환영합니다.
        <a href="{{ url_for('logout') }}" class="logout-link">(로그아웃)</a>
    </div>
    {% endif %}

    <h1 class="main-title">병실 환자 현황</h1>
    <div id="floor-view">
        <div id="current-floor-title"></div>
        <div id="rooms-area"></div>
    </div>
    <div id="beds-area" style="display: none;"></div>
</div>
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ▼▼▼ [최종] 슬라이드 메뉴 기능이 통합된 JavaScript 코드 ▼▼▼
$(function() {
    function updateClock() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        const timeString = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        $('#realtime-clock').text(timeString);
    }

    function updateContent(floor) {
        $('#current-floor-title').text(floor + '층 병동');
        $.get('/api/floor_rooms/' + floor, function(html) {
            $('#rooms-area').html(html);
        });
    }

    setInterval(updateClock, 1000);
    updateClock();
    updateContent(1);

    // 1. 층 탭(슬라이드 메뉴 안) 클릭 이벤트
    $('#bookmark-tabs').on('click', '.floor-btn', function() {
        $('#bookmark-tabs .floor-btn').removeClass('active');
        $(this).addClass('active');
        var floor = $(this).data('floor');
        updateContent(floor);
        // 확대된 방 초기화
        $('#rooms-area .rooms-container').removeClass('zoomed-in');
        $('#rooms-area .room-box').removeClass('selected');
        $('#patient-list-area').slideUp();
    });

 // 2. 방 클릭 이벤트 (최종 수정)
$(document).on('click', '.room-box', function(e) {
    e.stopPropagation();
    var roomBox = $(this);
    var roomName = roomBox.data('room');
    var container = roomBox.closest('.rooms-container');

    if (roomBox.hasClass('selected')) return;

    // 다른 방이 선택되어 있었다면 먼저 초기화
    container.find('.room-box.selected').removeClass('selected').find('.patient-list-container').remove();
    
    // 현재 방 선택 및 확대
    roomBox.addClass('selected');
    container.addClass('zoomed-in');
    
    // ▼▼▼ [핵심] API 호출 대신, data-patients 속성에서 데이터를 읽어옴 ▼▼▼
    var patients = roomBox.data('patients');

    // 상세 목록을 담을 컨테이너를 동적으로 생성
    roomBox.append('<div class="patient-list-container"></div>');
    var patientListContainer = roomBox.find('.patient-list-container');

    // ▼▼▼ [핵심] 상세 목록 디자인 HTML 생성 로직 (유지) ▼▼▼
    var patientListHtml = `<div class="patient-card" style="background-color: #ced4da;"><h4 style="width: 100%; text-align: center; color: #212529;">${roomName}</h4></div>`;

    if (patients && patients.length > 0) {
        patients.forEach(function(p) {
            patientListHtml += `
                <div class="patient-card">
                    <div class="patient-name-box">${p.patient_name}</div>
                    <div class="patient-details">${p.age}세 / ${p.gender} / ${p.bed_number}번 침대</div>
                </div>`;
        });
    } else {
        patientListHtml += '<p class="text-white text-center mt-3">현재 입원한 환자가 없습니다.</p>';
    }

    // 생성된 HTML을 컨테이너에 넣고 부드럽게 표시
    patientListContainer.html(patientListHtml).fadeIn();
});

// 3. 배경 클릭 시 축소 이벤트
$(document).on('click', function(e) {
    var container = $('.rooms-container.zoomed-in');
    if (container.length > 0 && $(e.target).closest('.room-box.selected').length === 0) {
        container.removeClass('zoomed-in');
        // 축소 시, 동적으로 생성했던 상세 목록 컨테이너를 삭제
        container.find('.room-box.selected').removeClass('selected').find('.patient-list-container').remove();
    }
});

    // 4. 슬라이드 메뉴 토글 이벤트
    $('#menu-toggle-btn').on('click', function(e) {
        e.stopPropagation();
        $('#slide-menu').toggleClass('open');
    });

    // 5. 메뉴 바깥쪽 클릭 시 메뉴 닫기 이벤트
    $(document).on('click', function(e) {
        if ($('#slide-menu').hasClass('open') && !$(e.target).closest('#slide-menu').length && !$(e.target).is('#menu-toggle-btn')) {
            $('#slide-menu').removeClass('open');
        }
    });
});
</script>

</body>
</html>